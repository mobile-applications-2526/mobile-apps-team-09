# ===========================================
# PlantSense AI - Production with Docker Secrets
# ===========================================
# Use this for production with Docker Swarm
# Deploy with: docker stack deploy -c docker-compose.secrets.yml plantsense

version: "3.8"

services:
  # PlantSense AI Backend API
  backend:
    image: plantsense/api:latest
    ports:
      - "8000:8000"
    environment:
      - APP_NAME=PlantSense AI Backend
      - DEBUG=False
      - ALGORITHM=HS256
      - ACCESS_TOKEN_EXPIRE_MINUTES=30
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
      - api_secret_key
    depends_on:
      - db
    networks:
      - plantsense_network
    deploy:
      replicas: 2
      restart_policy:
        condition: on-failure

  # PostgreSQL Database for PlantSense AI
  db:
    image: postgres:15-alpine
    secrets:
      - postgres_user
      - postgres_password
      - postgres_db
    environment:
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
    volumes:
      - plantsense_data:/var/lib/postgresql/data
    networks:
      - plantsense_network
    deploy:
      placement:
        constraints:
          - node.role == manager

networks:
  plantsense_network:
    driver: overlay

volumes:
  plantsense_data:

secrets:
  postgres_user:
    external: true
  postgres_password:
    external: true
  postgres_db:
    external: true
  api_secret_key:
    external: true
# ===========================================
# How to use Docker Secrets:
# ===========================================
# 1. Initialize Docker Swarm:
#    docker swarm init
#
# 2. Create secrets:
#    echo "plantsense" | docker secret create postgres_user -
#    echo "super_secure_password_123" | docker secret create postgres_password -
#    echo "plantsense_db" | docker secret create postgres_db -
#    openssl rand -hex 32 | docker secret create api_secret_key -
#
# 3. Deploy stack:
#    docker stack deploy -c docker-compose.secrets.yml plantsense
#
# 4. View services:
#    docker stack services plantsense
#
# 5. Remove stack:
#    docker stack rm plantsense

